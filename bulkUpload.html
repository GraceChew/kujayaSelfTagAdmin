<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Bulk Upload Candidate</title>
        <link rel="icon" type="image/png" href="images/kujaya.ico">
        <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
        <link href="css/bootstrap.min.css" rel="stylesheet" />
        <link href="css/light-bootstrap-dashboard.css?v=2.0.0" rel="stylesheet" />
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous"></script>

        <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-database.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.15.5/firebase-storage.js"></script>

        <link rel="stylesheet" type="text/css" href="css/customized.css">

        <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

        <script type="text/javascript" src="//code.jquery.com/jquery-2.1.0.js"></script>
        <script type="text/javascript" src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">


        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
        
    
    </head>
    
    <body>
        <div class="wrapper">
            <div class="sidebar" data-image="images/sidebar-4.jpg">
                <div class="sidebar-wrapper">
                    <div class="logo">
                        <img src="images/kujaya.png" alt="kujaya logo" style="width:20%" />
                        Kujaya Self Tag
                    </div>
                    <ul class="nav">
                        <li class="nav-item">
                            <a class="nav-link" href="mainPage_new.html">
                                <i class="nc-icon nc-chart-pie-35"></i>
                                <p>Dashboard</p>
                            </a>
                        </li>
                        <li>
                            <a class="nav-link" href="masterCandidate.html">
                                <i class="nc-icon nc-circle-09"></i>
                                <p>Master Candidate</p>
                            </a>
                        </li>
                        <li class="active">
                            <a class="nav-link" href="bulkUpload.html">
                                <i class="nc-icon nc-cloud-upload-94"></i>
                                <p>Bulk Upload</p>
                            </a>
                            <ul class="ml-5">
<!--                                 <li class="pt-1 pb-1"><a style="color: white; font-size: 14px;" href="#">Bulk Upload</a></li> -->
<!--                                 <li class="pt-1 pb-1"><a style="color: white; font-size: 14px;" href="addCandidate.html">Single Upload Candidate</a></li> -->
                            </ul>
                        </li>
                        <li>
                            <a id="Logout" class="nav-link" href="javascript: isLogout()">
                                <i class="nc-icon nc-button-power"></i>
                                <p>Logout</p>
                            </a>
                        </li>
    
                        <!--<li class="nav-item active active-pro">
                        <a class="nav-link active" href="upgrade.html">
                            <i class="nc-icon nc-alien-33"></i>
                            <p>Upgrade to PRO</p>
                        </a>
                    </li>-->
                    </ul>
                </div>
            </div>

            <div class="main-panel">
                <nav class="navbar navbar-expand-lg " color-on-scroll="500">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#pablo"> Bulk Upload Candidate </a>
                    </div>
                </nav>

                <div class="content">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card-title mb-5">Follow 3 Steps to Bulk Upload Candidate</h4>
                                    </div>
                                    <div class="card-body">
                                        <section id="tabs" class="project-tab">
                                            <div class="container">
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <nav>
                                                            <div class="nav nav-tabs nav-fill nav-pills" id="nav-tab" role="tablist">
                                                                <a class="nav-item nav-link active" id="nav-step1-tab" data-toggle="tab" href="#nav-step1" role="tab" aria-controls="nav-home" aria-selected="true"><h4>Step 1 - Select File</h4></a>
                                                                <a class="nav-item nav-link  " id="nav-step2-tab" data-toggle="tab" href="#nav-step2" role="tab" aria-controls="nav-profile" aria-selected="false"><h4>Step 2 - Upload In Progress</h4></a>
                                                                <!-- <a class="nav-item nav-link disabled" id="nav-step3-tab" data-toggle="tab" href="#nav-step3" role="tab" aria-controls="nav-contact" aria-selected="false"><h4>Step 3 - Check Result</h4></a> -->
                                                            </div>
                                                        </nav>
                                                        <div class="tab-content" id="nav-tabContent">
                                                            <div class="tab-pane fade show active" id="nav-step1" role="tabpanel" aria-labelledby="nav-step1-tab">
                                                                <div class="row mt-3">
                                                                    <div class="col-12">
                                                                        <h4>1. Download excel template</h4>
                                                                        <ul style="list-style-type:square;">
                                                                            <li>Make sure excel contains columns:
                                                                                <ol>
                                                                                    <li class="pt-2"><b>candidateName</b></li>
                                                                                    <li class="pt-2"><b>candidateIc</b></li>
                                                                                    <li class="pt-2"><b>candidateAgent </b>:<i> agent name must be same as you register in the app, else agent might have problem to check candidate clock in record </i></li>
                                                                                    <li class="pt-2"><b>candidateCompany</b>: <i> company name must be same as you register in the app</i></li>
                                                                                    <li class="pt-2"><b>candidatePhone</b>: no need +6 country code</li>
                                                                                    <!-- <li>candidateStatus</li> -->
                                                                                    <li class="pt-2"><b>candidateTransport</b>: make sure it's only<span style="color: #dc3545 ;"> BY BUS </span> or <span style="color: #dc3545 ;">OWN TRANSPORT</span></li>
                                                                                </ol>
                                                                            </li>
                                                                            <li class="mt-2">Or you can download excel template from here, and fill in candidate info:
                                                                                <a href="CANDIDATE TEMPLATE.xlsx" download>
                                                                                    <img src="/images/excel-xls-icon-2.png" alt="candidate template file" width="50" height="50">
                                                                                </a>
                                                                            </li>
                                                                           
                                                                        </ul>


                                                                        <h4 class="mt-3">2. Select Excel File:</h4>
                                                                        <div class="row mt-3">
                                                                            <div class="custom-file mb-3 col-5 ">
                                                                                <input type="file" class="form-control" id="excelFile"  accept=".xls, .xlsx">
                                                                                <!-- <label class="custom-file-label" for="customFile">Choose Excel file</label> -->
                                                                            </div>
                                                                            <div class="col-3"><button id="buttonExcel" class="btn btn-primary">Start checking excel content</button></div>
                                                                        </div>
                                                                        <div class="row mt-2">
                                                                            <ol id="checkResult" style="list-style-type: none;">
                                                                                
                                                                            </ol>
                                                                        </div>


                                                                        <h4 class="mt-5">3. Upload to Database</h4>
                                                                        <p><img src="images/warning20.png"><mark>Cautious: You cannot undo it once the data is upload to database! </mark> </p>
                                                                        <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
                                                                            <a class="nav-item nav-link btn btn-success disabled" id="nav-step2-tab-bottom" data-toggle="tab" href="#nav-step2" role="tab" aria-controls="nav-profile" aria-selected="false">Click here >> Upload Data To Database</a>
                                                                            <!-- <a href="#" id="buttonUpload" class="btn btn-light btn-lg btn-block mt-3 disabled"  data-toggle="tab" href="#nav-step2" role="tab" aria-controls="nav-profile" aria-selected="false">Link Button</a>
                                                                            <button type="button" id="buttonUpload" class="btn btn-light btn-lg btn-block mt-3" disabled>Click here >> Upload Data To Database</button> -->
                                                                        </div>
                                                                        
                                                                    </div>
                                                                   
                                                                </div>
                                                            </div>
                                                            <div class="tab-pane fade" id="nav-step2" role="tabpanel" aria-labelledby="nav-step2-tab">
                                                                <div class="row">
                                                                    <div class="col-12">
                                                                        <h3 id="titleUpload" class="text-center">Updating candidate, please do not close this window</h3>
                                                                        <div class="progress mt-5">
                                                                            <div id="progressUpload" class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 0%; font-size: 15px; color: white;"></div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-12">
                                                                        <h5>Details progress:</h5>
                                                                        <div class="row mt-2">
                                                                            <ol id="uploadResult" style="list-style-type: none;">
                                                                                
                                                                            </ol>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                            </div>
                                                            
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </section>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <script src="js/index.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.4/xlsx.full.min.js"></script>
        <script>
        
            firebase.auth().onAuthStateChanged(function(user){
                if(!user){
                    window.location.href = "signin.html";
                }
            });

            // $(".custom-file-input").on("change", function() {
            //     var fileName = $(this).val().split("\\").pop();
            //     $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
                
            // });

            let selectedFile;
            var arrayExcel;

            document.getElementById('excelFile').addEventListener("change", (event)=>{
                selectedFile = event.target.files[0];
            })

            document.getElementById('buttonExcel').addEventListener("click", (event)=>{
                if(selectedFile){
                    let fileReader = new FileReader();
                    fileReader.readAsBinaryString(selectedFile);
                    fileReader.onload = (event)=>{
                        // console.log(event.target.result);
                        let data = event.target.result;
                        let workbook = XLSX.read(data, {type:"binary"});
                        console.log(workbook);
                        // workbook.SheetNames.forEach(sheet => { });
                            let rowObject = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[workbook.SheetNames[0]]);
                            //console.log(rowObject);
                            //console.log(JSON.stringify(rowObject, undefined, 4));
                            arrayExcel = JSON.parse(JSON.stringify(rowObject));
                            console.log(arrayExcel);

                            var result = false;

                            //clear list first
                            var list = document.getElementById("checkResult");
                            while (list.hasChildNodes()) {  
                            list.removeChild(list.firstChild);
                            }

                            //name start
                            result = arrayExcel.every((item) => {
                                return item.candidateName
                            });
                            console.log("name check: "+result);
                            if(result){
                                $("#checkResult").append('<li style="color: green;margin-bottom:5px;"><i class="fa fa-check" aria-hidden="true"></i></i>Name Ok</li>');
                            }else{
                                $("#checkResult").append('<li style="color: red;margin-bottom:5px;"><i class="fa fa-times" aria-hidden="true"></i></i>Name cannot be empty, please check again</li>');
                            }

                            //ic start
                            result = arrayExcel.every((item) => {
                                return item.candidateIc
                            });
                            console.log("ic check: "+result);
                            if(result){
                                $("#checkResult").append('<li style="color: green;margin-bottom:5px;"><i class="fa fa-check" aria-hidden="true"></i></i>IC Ok</li>');
                            }else{
                                $("#checkResult").append('<li style="color: red;margin-bottom:5px;"><i class="fa fa-times" aria-hidden="true"></i></i>IC cannot be empty, please check again</li>');
                            }

                            //agent start
                            result = arrayExcel.every((item) => {
                                return item.candidateAgent 
                            });
                            console.log("agent check: "+result);
                            if(result){
                                $("#checkResult").append('<li style="color: green;margin-bottom:5px;"><i class="fa fa-check" aria-hidden="true"></i></i>Agent Ok</li>');
                            }else{
                                $("#checkResult").append('<li style="color: red;margin-bottom:5px;"><i class="fa fa-times" aria-hidden="true"></i></i>Agent cannot be empty, please check again</li>');
                            }
                            
                            //company start
                            result = arrayExcel.every((item) => {
                                return item.candidateCompany 
                            });
                            console.log("company check: "+result);
                            if(result){
                                $("#checkResult").append('<li style="color: green;margin-bottom:5px;"><i class="fa fa-check" aria-hidden="true"></i></i>Company Ok</li>');
                            }else{
                                $("#checkResult").append('<li style="color: red;margin-bottom:5px;"><i class="fa fa-times" aria-hidden="true"></i></i>Company cannot be empty, please check again</li>');
                            }

                            //phone start
                            result = arrayExcel.every((item) => {
                                return item.candidatePhone && !item.candidatePhone.includes("+6");
                            });
                            console.log("phone check: "+result);
                            if(result){
                                $("#checkResult").append('<li style="color: green;margin-bottom:5px;"><i class="fa fa-check" aria-hidden="true"></i></i>Phone Ok</li>');
                            }else{
                                $("#checkResult").append('<li style="color: red;margin-bottom:5px;"><i class="fa fa-times" aria-hidden="true"></i></i>Phone cannot be empty or have +6, please check again</li>');
                            }

                            //transport start
                            result = arrayExcel.every((item) => {
                                return item.candidateTransport 
                            });
                            console.log("transport check: "+result);
                            if(result){
                                $("#checkResult").append('<li style="color: green;margin-bottom:5px;"><i class="fa fa-check" aria-hidden="true"></i></i>Transport Ok</li>');
                                
                                // transport type start
                                const transport = arrayExcel.map((item) => {
                                    return item.candidateTransport.toUpperCase().trim();
                                })
                                console.log("transport list: "+transport);

                                const unique = (value, index, self) => {
                                    return self.indexOf(value) === index
                                }
                                const uniqueTransport = transport.filter(unique)

                                console.log(uniqueTransport);
                                result = uniqueTransport.every((item) => {
                                    return item === "BY BUS" || item === "OWN TRANSPORT"
                                });

                                console.log("transport type check: "+result);
                                if(result){
                                $("#checkResult").append('<li style="color: green;margin-bottom:5px;"><i class="fa fa-check" aria-hidden="true"></i></i>Transport Type Ok</li>');
                                }else{
                                    $("#checkResult").append('<li style="color: red;margin-bottom:5px;"><i class="fa fa-times" aria-hidden="true"></i></i>Transport Type should only BY BUS or OWN TRANSPORT</li>');
                                }
                                // check transport end

                            }else{
                                $("#checkResult").append('<li style="color: red;margin-bottom:5px;"><i class="fa fa-times" aria-hidden="true"></i></i>Transport cannot be empty, please check again</li>');
                            }

                            if(result){
                                console.log("OK");
                                var element = document.getElementById('nav-step2-tab-bottom');
                                element.disabled = false
                                element.classList.remove("btn-light");
                                element.classList.remove("disabled");
                                element.classList.add("btn-success");
                               // $("#nav-tab li:eq(1) a").tab('show'); // show 2nd tab on page load
                            }
                            else{
                                console.log("NOT OK");
                            }
                        
                    }
                }
                else{
                    alert("Please select excel file first");
                }
            })

            document.getElementById('nav-step2-tab-bottom').addEventListener("click", (event)=>{

                if (confirm("Are you sure want to upload? It cannot be undo")) {
                    var element2 = document.getElementById('nav-step2-tab');
                    element2.disabled = false
                    element2.classList.remove("disabled");
                    element2.classList.add("active");
                    $('a[href="nav-step2"]').tab('show');

                    var element1 = document.getElementById('nav-step1-tab');
                    element1.disabled = true
                    element1.classList.add("disabled");
                    element1.classList.remove("active");

                    //clear list first
                    var list = document.getElementById("uploadResult");
                            while (list.hasChildNodes()) {  
                            list.removeChild(list.firstChild);
                            }

                    var progress = document.getElementById("progressUpload");
                    var len = arrayExcel.length;
                    var recordNum = 0;

                    for(var i = 0; i< len; i++){
                        var recordNum = i + 1;
                        var currentPercent = Math.round((recordNum/len) * 100);

                        name = arrayExcel[i]["candidateName"];
                        ic = arrayExcel[i]["candidateIc"];
                        agent = arrayExcel[i]["candidateAgent"];
                        company = arrayExcel[i]["candidateCompany"];
                        phone = arrayExcel[i]["candidatePhone"];
                        transport = arrayExcel[i]["candidateTransport"];
                        uploadToFirebase(name, ic, agent, company, phone, transport, currentPercent, len, recordNum);   

                    }                    

                } else {
                    
                }
                
                
            })

    
</script>
        </script>
    </body>
</html>
